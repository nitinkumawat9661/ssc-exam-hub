<!DOCTYPE html>
<html lang="en">
<head>
    <title>Dashboard - SSC Hub</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        .gradient-header { background: linear-gradient(135deg, #0061ff 0%, #60efff 100%); color: white; border-radius: 0 0 25px 25px; padding: 20px 15px 50px; }
        .card-float { margin-top: -40px; border-radius: 15px; background: white; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .dose-box { background: #f8f9fa; border-left: 5px solid #0d6efd; padding: 10px; font-size: 0.9rem; }
        .chat-bubble { font-size: 0.9rem; line-height: 1.5; }
    </style>
</head>
<body class="bg-light">

    <div class="gradient-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h5 class="mb-0 fw-bold">Hi, {{ user.name }}! ğŸ‘‹</h5>
                <small class="text-white-50" style="font-size: 0.8rem;">{{ settings.notice_text }}</small>
            </div>
            <div class="d-flex align-items-center gap-2">
                <a href="/profile"><img src="{{ profile_pic }}" width="40" height="40" class="rounded-circle border border-2 border-white"></a>
                <a href="/logout" class="btn btn-danger btn-sm rounded-circle d-flex align-items-center justify-content-center" style="width:35px;height:35px;">ğŸšª</a>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Stats -->
        <div class="card-float p-3 mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-0 fw-bold text-warning">ğŸ’° {{ user.coins }}</h2>
                    <small class="text-muted">Coins</small>
                </div>
                <button class="btn btn-success rounded-pill px-3 btn-sm fw-bold" data-bs-toggle="modal" data-bs-target="#paymentModal">+ Buy</button>
            </div>
            <hr>
            <!-- AI Generated Daily Dose -->
            <small class="text-uppercase fw-bold text-primary">ğŸ’¡ Today's Dose (AI)</small>
            <div class="dose-box mt-1">
                {{ daily_fact | safe }}
            </div>
        </div>

        <!-- AI Tutor -->
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-body">
                <h6 class="fw-bold mb-2">ğŸ¤– Ask SSC Guru</h6>
                <div class="input-group">
                    <input type="text" id="aiQ" class="form-control" placeholder="Math, GK, Grammar...">
                    <button onclick="askAI()" class="btn btn-primary">Ask</button>
                </div>
                <div id="aiResponse" class="mt-3 p-2 bg-white border rounded d-none chat-bubble text-secondary"></div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="row g-3 mb-5">
            <div class="col-6"><a href="/library" class="btn btn-white bg-white w-100 py-3 shadow-sm fw-bold text-primary border-0">ğŸ“š Library</a></div>
            <div class="col-6"><a href="/flashcards" class="btn btn-white bg-white w-100 py-3 shadow-sm fw-bold text-danger border-0">ğŸ“ Flashcards</a></div>
            {% if user.is_admin %}
            <div class="col-12"><a href="/admin" class="btn btn-dark w-100 py-2 fw-bold shadow-sm">âš™ï¸ Admin Panel</a></div>
            {% endif %}
        </div>
    </div>

    <!-- Payment Modal -->
    <div class="modal fade" id="paymentModal">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center">
                    <h5 class="fw-bold">UPI Payment</h5>
                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=upi://pay?pa={{ settings.upi_id }}&pn={{ settings.upi_name }}&cu=INR" class="img-fluid border p-2 rounded my-2">
                    <p class="small mb-1">ID: <span class="fw-bold select-all">{{ settings.upi_id }}</span></p>
                    <hr>
                    <form method="POST" action="/submit_payment">
                        <input type="number" name="amount" class="form-control mb-2" placeholder="Amount (â‚¹)" required>
                        <input type="text" name="utr" class="form-control mb-2" placeholder="12-digit UTR" required>
                        <button type="submit" class="btn btn-primary w-100">Verify Payment</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        function askAI() {
            let q = document.getElementById('aiQ').value;
            if(!q) return;
            let box = document.getElementById('aiResponse');
            box.innerText = "ğŸ¤– Thinking..."; box.classList.remove('d-none');
            
            let fd = new FormData(); fd.append('question', q);
            fetch('/ask_ai', {method: 'POST', body: fd})
            .then(r=>r.json())
            .then(d=>{
                // Use Marked.js to render clean HTML
                box.innerHTML = marked.parse(d.answer);
            });
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
