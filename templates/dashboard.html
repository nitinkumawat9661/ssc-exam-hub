<!DOCTYPE html>
<html lang="en">
<head>
    <title>Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Link Manifest -->
    <link rel="manifest" href="/static/manifest.json">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        .gradient-header { background: linear-gradient(135deg, #0061ff 0%, #60efff 100%); color: white; border-radius: 0 0 25px 25px; padding: 20px 15px 50px; }
        .card-float { margin-top: -40px; border-radius: 15px; background: white; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .dose-box { background: #f8f9fa; border-left: 5px solid #0d6efd; padding: 10px; font-size: 0.9rem; }
    </style>
</head>
<body class="bg-light">
    <div class="gradient-header">
        <div class="d-flex justify-content-between align-items-center">
            <div><h5 class="mb-0 fw-bold">Hi, {{ user.name }}!</h5><small class="text-white-50">{{ settings.notice_text }}</small></div>
            <div class="d-flex gap-2">
                <a href="/profile"><img src="{{ profile_pic }}" width="40" height="40" class="rounded-circle border border-2 border-white"></a>
                <a href="/logout" class="btn btn-danger btn-sm rounded-circle d-flex align-items-center justify-content-center" style="width:35px;height:35px;">ğŸšª</a>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- INSTALL APP BUTTON (Hidden by default) -->
        <div id="installContainer" class="d-none mb-3 text-center" style="margin-top: -60px; position: relative; z-index: 10;">
            <button onclick="installApp()" class="btn btn-light fw-bold shadow-sm text-primary px-4 rounded-pill">
                ğŸ“² Install App
            </button>
        </div>

        <div class="card-float p-3 mb-4" id="mainCard">
            <div class="d-flex justify-content-between align-items-center">
                <div><h2 class="mb-0 text-warning fw-bold">ğŸ’° {{ user.coins }}</h2><small class="text-muted">Coins</small></div>
                <button class="btn btn-success rounded-pill px-3 btn-sm" data-bs-toggle="modal" data-bs-target="#paymentModal">+ Buy</button>
            </div>
            <hr>
            <small class="text-uppercase fw-bold text-primary">ğŸ’¡ Today's Dose</small>
            <div class="dose-box mt-1">{{ daily_fact | safe }}</div>
        </div>

        <!-- AI Chat -->
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-body">
                <h6 class="fw-bold mb-2">ğŸ¤– Ask AI Tutor</h6>
                <div class="input-group">
                    <input type="text" id="aiQ" class="form-control" placeholder="Math/GK Doubt...">
                    <button onclick="askAI()" class="btn btn-primary">Ask</button>
                </div>
                <div id="aiResponse" class="mt-3 p-2 bg-white border rounded d-none small text-secondary"></div>
            </div>
        </div>

        <!-- Menu -->
        <div class="row g-3 mb-3">
            <div class="col-6"><a href="/library" class="btn btn-white bg-white w-100 py-3 shadow-sm text-primary border-0 fw-bold">ğŸ“š Library</a></div>
            <div class="col-6"><a href="/flashcards" class="btn btn-white bg-white w-100 py-3 shadow-sm text-danger border-0 fw-bold">ğŸ“ Flashcards</a></div>
            
            {% if settings.ads_enabled %}
            <div class="col-12">
                <button onclick="startAd()" class="btn btn-warning w-100 py-2 shadow-sm text-dark fw-bold border-0">
                    ğŸ“º Watch Ad (+{{ settings.ad_reward }})
                </button>
            </div>
            {% endif %}
            
            {% if user.is_admin %}
            <div class="col-12"><a href="/admin" class="btn btn-dark w-100 py-2 shadow-sm fw-bold">âš™ï¸ Admin Panel</a></div>
            {% endif %}
        </div>
    </div>

    <!-- Modals (Ad & Payment) remain same... -->
    <div class="modal fade" id="adModal" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content text-center p-4">
                <h4 class="mb-3">ğŸ¬ Watching Ad...</h4>
                <div class="spinner-border text-primary mb-3"></div>
                <p>Wait <span id="timer" class="fw-bold text-danger">10</span>s...</p>
                <button id="claimBtn" class="btn btn-success w-100 d-none" onclick="finishAd()">ğŸ Claim Reward</button>
            </div>
        </div>
    </div>

    <div class="modal fade" id="paymentModal">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content text-center p-4">
                <h5>UPI Payment</h5>
                <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=upi://pay?pa={{ settings.upi_id }}&pn={{ settings.upi_name }}&cu=INR" class="img-fluid border p-2 rounded my-2">
                <p class="small">ID: <span class="fw-bold select-all">{{ settings.upi_id }}</span></p>
                <form method="POST" action="/submit_payment">
                    <input type="number" name="amount" class="form-control mb-2" placeholder="â‚¹ Amount" required>
                    <input type="text" name="utr" class="form-control mb-2" placeholder="UTR Number" required>
                    <button type="submit" class="btn btn-primary w-100">Verify</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // --- INSTALL APP LOGIC ---
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            // Show the button only if install is available
            document.getElementById('installContainer').classList.remove('d-none');
            document.getElementById('mainCard').style.marginTop = "10px"; // Adjust spacing
        });

        async function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    document.getElementById('installContainer').classList.add('d-none');
                }
                deferredPrompt = null;
            }
        }

        // --- EXISTING LOGIC ---
        function askAI() {
            let q = document.getElementById('aiQ').value;
            if(!q) return;
            let box = document.getElementById('aiResponse');
            box.innerText = "Thinking..."; box.classList.remove('d-none');
            let fd = new FormData(); fd.append('question', q);
            fetch('/ask_ai', {method: 'POST', body: fd}).then(r=>r.json()).then(d=>{box.innerHTML = marked.parse(d.answer);});
        }

        var adModal;
        function startAd() {
            adModal = new bootstrap.Modal(document.getElementById('adModal'));
            adModal.show();
            let timeLeft = 10;
            let timerSpan = document.getElementById('timer');
            let interval = setInterval(() => {
                timeLeft--; timerSpan.innerText = timeLeft;
                if(timeLeft <= 0) {
                    clearInterval(interval);
                    document.querySelector('.spinner-border').classList.add('d-none');
                    document.getElementById('claimBtn').classList.remove('d-none');
                }
            }, 1000);
        }
        function finishAd() {
            fetch('/watch_ad', {method: 'POST'}).then(r=>r.json()).then(d=>{
                adModal.hide(); alert(d.msg); location.reload();
            });
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
